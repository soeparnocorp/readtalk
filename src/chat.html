<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
* { box-sizing: border-box; margin:0; padding:0; font-family: Arial, Helvetica, sans-serif; }
body { height: 100vh; display: flex; flex-direction: column; }

/* Chat log */
#chatlog { flex: 1; overflow-y: auto; padding: 8px; display: flex; flex-direction: column; gap: 4px; }
.chat-bubble { padding: 8px 12px; border-radius: 16px; max-width: 70%; word-break: break-word; }
.chat-bubble.self { background-color: #DCF8C6; margin-left: auto; }
.chat-bubble.other { background-color: #FFF; margin-right: auto; }

/* Roster */
#roster { display:none; }

/* Input area */
#chat-input { width: 100%; padding: 8px; font-size: 16px; border: none; resize: none; max-height: 120px; overflow-y: auto; }

/* Forms overlay */
#name-form, #room-form { position: fixed; top:0; left:0; right:0; bottom:0; background:white; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:10; }
#name-input, #room-name { font-size: 1.5em; padding:0.5em; width: 16em; text-align:center; margin-bottom:1em; }
#room-form button { font-size:1em; padding:0.5em 1em; margin:0.5em; }
</style>
</head>
<body>

<form id="name-form" action="/fake-form-action">
  <input id="name-input" placeholder="Your name">
  <p>This chat runs entirely on the edge<br>
    <a href="https://blog.cloudflare.com/introducing-workers-durable-objects" target="_blank">Durable Objects</a></p>
</form>

<form id="room-form" action="/fake-form-action">
  <input id="room-name" placeholder="Room name">
  <button id="go-public">Go Public</button>
  <button id="go-private">Private Room</button>
</form>

<div id="chat-container" style="flex:1; display:none; flex-direction:column;">
  <div id="chatlog"></div>
  <textarea id="chat-input" rows="1" placeholder="Type a message..."></textarea>
</div>

<script>
let username, roomname, currentWebSocket=null;
let nameForm=document.querySelector("#name-form");
let nameInput=document.querySelector("#name-input");
let roomForm=document.querySelector("#room-form");
let roomNameInput=document.querySelector("#room-name");
let goPublicButton=document.querySelector("#go-public");
let goPrivateButton=document.querySelector("#go-private");
let chatContainer=document.querySelector("#chat-container");
let chatlog=document.querySelector("#chatlog");
let chatInput=document.querySelector("#chat-input");

// ===== Name Form =====
nameForm.addEventListener("submit", e => {
  e.preventDefault();
  username = nameInput.value.slice(0,32);
  if(username) { nameForm.style.display="none"; roomForm.style.display="flex"; }
});

// ===== Room Form =====
roomForm.addEventListener("submit", e => {
  e.preventDefault();
  roomname = roomNameInput.value.replace(/[^a-zA-Z0-9_-]/g,"").slice(0,32);
  if(roomname) startChat();
});

goPublicButton.addEventListener("click", e => {
  e.preventDefault();
  roomname = roomNameInput.value.replace(/[^a-zA-Z0-9_-]/g,"").slice(0,32);
  if(roomname) startChat();
});

goPrivateButton.addEventListener("click", async e => {
  e.preventDefault();
  let resp = await fetch(`${location.protocol}//${location.host}/api/room`, {method:"POST"});
  if(!resp.ok){ alert("Error"); location.reload(); return; }
  roomname = await resp.text();
  startChat();
});

// ===== Chat =====
function startChat(){
  roomForm.style.display="none";
  chatContainer.style.display="flex";
  location.hash="#"+roomname;

  chatInput.addEventListener("input", ()=> {
    chatInput.style.height="auto";
    chatInput.style.height=chatInput.scrollHeight+"px";
    chatlog.scrollTop = chatlog.scrollHeight;
  });

  chatInput.addEventListener("keydown", e => { if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); sendMessage(); } });
  joinRoom();
}

// ===== WebSocket =====
function joinRoom(){
  let proto = location.protocol==="http:"?"ws:":"wss:";
  let ws = new WebSocket(`${proto}//${location.host}/api/room/${roomname}/websocket`);
  ws.addEventListener("open", ()=> ws.send(JSON.stringify({name:username})));
  ws.addEventListener("message", e => {
    let data = JSON.parse(e.data);
    if(data.error) addChatMessage(null,"* Error: "+data.error);
    else if(data.joined) addChatMessage(null,data.joined+" joined");
    else if(data.quit) addChatMessage(null,data.quit+" left");
    else if(data.ready) addChatMessage(null,"* Welcome "+username);
    else if(data.message) addChatMessage(data.name,data.message);
    else addChatMessage(data.name,data.message);
  });
  ws.addEventListener("close", ()=> setTimeout(joinRoom,3000));
  ws.addEventListener("error",()=>{ ws.close(); });
  currentWebSocket = ws;
}

function sendMessage(){
  if(currentWebSocket && chatInput.value.trim()){
    currentWebSocket.send(JSON.stringify({message:chatInput.value}));
    chatInput.value=""; chatInput.style.height="auto";
  }
}

// ===== Chat Bubble =====
function addChatMessage(name,text){
  let p=document.createElement("div");
  if(name===username) p.className="chat-bubble self";
  else p.className="chat-bubble other";
  if(name && name!==username){ let span=document.createElement("span"); span.textContent=name+": "; p.appendChild(span); }
  p.appendChild(document.createTextNode(text));
  chatlog.appendChild(p);
  chatlog.scrollTop=chatlog.scrollHeight;
}
</script>
</body>
</html>
