<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style type="text/css">
        /* ============================================
           ORIGINAL EDGE-CHAT-DEMO STYLES (PRESERVED)
        ============================================ */
        * {
          box-sizing: border-box;
        }
        
        body {
          font-family: Arial, Helvetica, sans-serif;
        }

        #chatlog {
          position: fixed;
          top: 0;
          bottom: 32px;
          left: 0;
          right: 200px;
          overflow-y: auto;
          padding: 8px;
          overflow-wrap: break-word;
        }
        #chatlog span.username {
          font-weight: bold;
        }
        #spacer {
          height: calc(100vh - 32px - 5em);
        }

        #roster {
          font-weight: bold;
          padding: 8px;
        }

        p {
          margin-top: 0;
          margin-bottom: 8px;
        }
        p:last-of-type {
          margin: 0;
        }

        #roster {
          position: fixed;
          right: 0;
          top: 0;
          bottom: 32px;
          width: 200px;
          border-left: none;
        }

        ::-webkit-scrollbar {
          display: none;
        }

        #chat-input {
          position: fixed;
          width: 100%;
          height: 32px;
          bottom: 0;
          left: 0;
          border: none;
          border-top: none;
          padding-left: 32px;
          outline: none;
        }
        #chatroom::before {
          z-index: 1;
          display: block;
          content: ">";
          position: fixed;
          bottom: 0;
          left: 0;
          width: 32px;
          height: 32px;
          line-height: 32px;
          text-align: center;
          font-weight: bold;
          color: #888;
          -webkit-text-stroke-width: 2px;
        }

        #name-form {
          position: fixed;
          z-index: 3;
          top: 0;
          bottom: 0;
          left: 0;
          right: 0;
          background-color: white;
        }

        #name-input {
          position: fixed;
          font-size: 200%;
          top: calc(50% - 1em);
          left: calc(50% - 8em);
          width: 16em;
          height: 2em;
          margin: 0;
          text-align: center;
          border: 1px solid #bbb;
        }

        #name-form p {
          position: fixed;
          top: calc(50% + 3em);
          width: 100%;
          text-align: center;
        }

        #room-form {
          position: fixed;
          z-index: 2;
          top: 0;
          bottom: 0;
          left: 0;
          right: 0;
          background-color: white;
          font-size: 200%;
          margin-top: calc(50vh - 3em);
          text-align: center;
        }

        #room-name {
          font-size: inherit;
          border: 1px solid #bbb;
          height: 2em;
          width: 16em;
          padding-left: 1em;
        }

        #room-form button {
          font-size: inherit;
          border: 1px solid #bbb;
          background-color: #eee;
          height: 2em;
        }

        #go-public {
          width: 4em;
        }
        #go-private {
          width: 20em;
        }

        /* ============================================
           MOBILE OPTIMIZATIONS (PRESERVED)
        ============================================ */
        @media(max-width:600px) {
          #roster { display: none; }
          #chatlog { right: 0; }
        }

        @media(max-width:660px) {
          #name-input, #room-form { font-size: 150%; }
          #name-form p { font-size: 75%; }
        }
        @media(max-width:500px) {
          #name-input, #room-form { font-size: 100%; }
          #name-form p { font-size: 50%; }
        }

        /* ============================================
           DESKTOP WHATSAPP WEB POSITIONING
           ONLY FOR SCREENS WIDER THAN 1024px
        ============================================ */
        @media (min-width: 1024px) {
          body {
            background: #0c1317;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          }
          
          /* WhatsApp Web Container */
          #chatroom {
            display: flex;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            background: #0c1317;
            position: relative;
          }
          
          /* Sidebar - Left (WhatsApp style) */
          #roster {
            position: relative;
            width: 480px;
            min-width: 380px;
            background: #111b21;
            border-right: 1px solid #222d34;
            display: flex !important;
            flex-direction: column;
            height: 100vh;
            top: 0;
            bottom: auto;
            padding: 0;
          }
          
          /* Sidebar Header */
          .sidebar-header {
            background: #202c33;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            border-bottom: 1px solid #222d34;
          }
          
          .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
          }
          
          .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff0000, #ff6666);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 18px;
          }
          
          /* Three-dot Menu */
          .menu-button {
            background: none;
            border: none;
            color: #aebac1;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
          }
          
          /* Room Info Section */
          .room-info {
            padding: 20px;
            border-bottom: 1px solid #222d34;
            color: #e9edef;
          }
          
          .room-info h3 {
            color: #ff0000;
            margin-bottom: 10px;
            font-size: 18px;
          }
          
          /* Online Users Section */
          .online-users {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            color: #e9edef;
          }
          
          .online-users h3 {
            color: #ff0000;
            margin-bottom: 15px;
            font-size: 16px;
          }
          
          /* Sidebar Footer */
          .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #222d34;
          }
          
          .leave-button {
            width: 100%;
            padding: 12px;
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
          }
          
          /* Chat Area - Right */
          #chatlog {
            position: relative;
            flex: 1;
            background: #0c1317;
            color: #e9edef;
            right: 0;
            top: 0;
            bottom: 62px;
            padding: 20px;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%2314222c' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E");
          }
          
          /* Message styling for desktop */
          #chatlog p {
            background: #202c33;
            color: #e9edef;
            border-radius: 7.5px;
            border-top-left-radius: 0;
            max-width: 65%;
            padding: 8px 12px;
            margin: 4px 0;
          }
          
          #chatlog span.username {
            color: #ff6666;
          }
          
          .system-message {
            background: rgba(255, 0, 0, 0.1);
            color: #ff6666;
            border: 1px solid rgba(255, 0, 0, 0.2);
            max-width: 80%;
            margin: 8px auto !important;
          }
          
          /* Input area for desktop */
          #chat-input-container {
            position: fixed;
            bottom: 0;
            left: 480px;
            right: 0;
            background: #202c33;
            border-top: 1px solid #222d34;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: calc(1600px - 480px);
            margin: 0 auto;
          }
          
          #chat-input {
            flex: 1;
            background: #2a3942;
            color: #e9edef;
            border: 1px solid #222d34;
            border-radius: 8px;
            padding: 12px 16px;
            height: auto;
            min-height: 44px;
            max-height: 100px;
            resize: none;
            font-size: 15px;
          }
          
          #chatroom::before {
            display: none;
          }
          
          /* Send button for desktop */
          #send-button {
            background: #ff0000;
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
          }
          
          /* Scrollbar for desktop */
          ::-webkit-scrollbar {
            display: block;
            width: 6px;
          }
          
          ::-webkit-scrollbar-track {
            background: transparent;
          }
          
          ::-webkit-scrollbar-thumb {
            background: rgba(255, 0, 0, 0.3);
            border-radius: 3px;
          }
        }

        /* ============================================
           TABLET VIEW (601px - 1023px)
        ============================================ */
        @media (min-width: 601px) and (max-width: 1023px) {
          #roster {
            width: 200px;
          }
          #chatlog {
            right: 200px;
          }
        }

        /* ============================================
           KEYBOARD OPTIMIZATION FIXES
           (Works on both mobile and desktop)
        ============================================ */
        
        /* Better textarea for mobile keyboard */
        #chat-input {
          padding: 8px 12px;
          font-size: 16px;
          line-height: 1.4;
          resize: none;
          min-height: 44px;
          max-height: 120px;
        }
        
        /* Mobile keyboard safe area */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
          #chat-input {
            padding-bottom: env(safe-area-inset-bottom);
          }
        }
        
        /* Input container for better keyboard handling */
        .input-container {
          display: flex;
          align-items: flex-end;
          gap: 8px;
          padding: 8px;
          background: white;
          border-top: 1px solid #ddd;
        }
        
        @media (min-width: 1024px) {
          .input-container {
            background: #202c33;
            border-top: 1px solid #222d34;
          }
        }
    </style>
  </head>
  <body>
    <!-- ORIGINAL HTML STRUCTURE - NO CHANGES -->
    <form id="name-form" action="/fake-form-action">
      <input id="name-input" placeholder="your name">
      <p>This chat runs entirely on the edge<br>with Durable Objects</p>
    </form>
    <form id="room-form" action="/fake-form-action">
      <p>Public Room:</p>
      <input id="room-name" placeholder="room name"><button id="go-public">Go &raquo;</button>
      <p>OR</p>
      <button id="go-private">Private Room &raquo;</button>
    </form>
    <form id="chatroom" action="/fake-form-action">
      <div id="chatlog">
        <div id="spacer"></div>
      </div>
      <div id="roster"></div>
      <!-- Modified input area for better keyboard handling -->
      <div class="input-container" id="input-container">
        <textarea id="chat-input" placeholder="Type your message... (Enter to send, Shift+Enter for new line)"></textarea>
        <button type="button" id="send-button" style="display: none;">Send</button>
      </div>
    </form>

    <script>
        // ============================================
        // ORIGINAL JAVASCRIPT - 100% PRESERVED
        // ============================================
        let currentWebSocket = null;

        let nameForm = document.querySelector("#name-form");
        let nameInput = document.querySelector("#name-input");
        let roomForm = document.querySelector("#room-form");
        let roomNameInput = document.querySelector("#room-name");
        let goPublicButton = document.querySelector("#go-public");
        let goPrivateButton = document.querySelector("#go-private");
        let chatroom = document.querySelector("#chatroom");
        let chatlog = document.querySelector("#chatlog");
        let chatInput = document.querySelector("#chat-input");
        let roster = document.querySelector("#roster");
        let sendButton = document.querySelector("#send-button");

        // Is the chatlog scrolled to the bottom?
        let isAtBottom = true;

        let username;
        let roomname;

        let hostname = window.location.host;
        if (hostname == "") {
          hostname = "room.soeparnocorp.workers.dev";
        }

        function startNameChooser() {
          nameForm.addEventListener("submit", event => {
            event.preventDefault();
            username = nameInput.value;
            if (username.length > 0) {
              startRoomChooser();
            }
          });

          nameInput.addEventListener("input", event => {
            if (event.currentTarget.value.length > 32) {
              event.currentTarget.value = event.currentTarget.value.slice(0, 32);
            }
          });

          nameInput.focus();
        }

        function startRoomChooser() {
          nameForm.style.display = "none";

          if (document.location.hash.length > 1) {
            roomname = document.location.hash.slice(1);
            startChat();
            return;
          }

          roomForm.style.display = "block";

          roomForm.addEventListener("submit", event => {
            event.preventDefault();
            roomname = roomNameInput.value;
            if (roomname.length > 0) {
              startChat();
            }
          });

          roomNameInput.addEventListener("input", event => {
            if (event.currentTarget.value.length > 32) {
              event.currentTarget.value = event.currentTarget.value.slice(0, 32);
            }
          });

          goPublicButton.addEventListener("click", event => {
            roomname = roomNameInput.value;
            if (roomname.length > 0) {
              startChat();
            }
          });

          goPrivateButton.addEventListener("click", async event => {
            roomNameInput.disabled = true;
            goPublicButton.disabled = true;
            event.currentTarget.disabled = true;

            let response = await fetch("https://" + hostname + "/api/room", {method: "POST"});
            if (!response.ok) {
              alert("something went wrong");
              document.location.reload();
              return;
            }

            roomname = await response.text();
            startChat();
          });

          roomNameInput.focus();
        }

        function startChat() {
          roomForm.style.display = "none";

          // Normalize the room name a bit.
          roomname = roomname.replace(/[^a-zA-Z0-9_-]/g, "").replace(/_/g, "-").toLowerCase();

          if (roomname.length > 32 && !roomname.match(/^[0-9a-f]{64}$/)) {
            addChatMessage("ERROR", "Invalid room name.");
            return;
          }

          document.location.hash = "#" + roomname;

          // Setup enhanced keyboard handling
          setupKeyboardHandling();

          // Original event listeners
          chatInput.addEventListener("input", event => {
            if (event.currentTarget.value.length > 256) {
              event.currentTarget.value = event.currentTarget.value.slice(0, 256);
            }
          });

          chatlog.addEventListener("scroll", event => {
            isAtBottom = chatlog.scrollTop + chatlog.clientHeight >= chatlog.scrollHeight;
          });

          chatInput.focus();
          document.body.addEventListener("click", event => {
            // If the user clicked somewhere in the window without selecting any text, focus the chat
            // input.
            if (window.getSelection().toString() == "") {
              chatInput.focus();
            }
          });

          // Detect mobile keyboard appearing and disappearing, and adjust the scroll as appropriate.
          if('visualViewport' in window) {
            window.visualViewport.addEventListener('resize', function(event) {
              if (isAtBottom) {
                chatlog.scrollBy(0, 1e8);
              }
            });
          }

          chatroom.style.display = "block";
          join();
        }

        let lastSeenTimestamp = 0;
        let wroteWelcomeMessages = false;

        function join() {
          // If we are running via wrangler dev, use ws:
          const wss = document.location.protocol === "http:" ? "ws://" : "wss://";
          let ws = new WebSocket(wss + hostname + "/api/room/" + roomname + "/websocket");
          let rejoined = false;
          let startTime = Date.now();

          let rejoin = async () => {
            if (!rejoined) {
              rejoined = true;
              currentWebSocket = null;

              // Clear the roster.
              while (roster.firstChild) {
                roster.removeChild(roster.firstChild);
              }

              // Don't try to reconnect too rapidly.
              let timeSinceLastJoin = Date.now() - startTime;
              if (timeSinceLastJoin < 10000) {
                // Less than 10 seconds elapsed since last join. Pause a bit.
                await new Promise(resolve => setTimeout(resolve, 10000 - timeSinceLastJoin));
              }

              // OK, reconnect now!
              join();
            }
          }

          ws.addEventListener("open", event => {
            currentWebSocket = ws;

            // Send user info message.
            ws.send(JSON.stringify({name: username}));
          });

          ws.addEventListener("message", event => {
            let data = JSON.parse(event.data);

            if (data.error) {
              addChatMessage(null, "* Error: " + data.error);
            } else if (data.joined) {
              let p = document.createElement("p");
              p.innerText = data.joined;
              roster.appendChild(p);
            } else if (data.quit) {
              for (let child of roster.childNodes) {
                if (child.innerText == data.quit) {
                  roster.removeChild(child);
                  break;
                }
              }
            } else if (data.ready) {
              // All pre-join messages have been delivered.
              if (!wroteWelcomeMessages) {
                wroteWelcomeMessages = true;
                addChatMessage(null,
                    "* This is a demo app built with Durable Objects.");
                addChatMessage(null,
                    "* WARNING: Participants in this chat are random people on the internet. " +
                    "Names are not authenticated. Chat history is saved.");
                if (roomname.length == 64) {
                  addChatMessage(null,
                      "* This is a private room. You can invite someone by sending them the URL.");
                } else {
                  addChatMessage(null,
                      "* Welcome to #" + roomname + ". Say hi!");
                }
              }
            } else {
              // A regular chat message.
              if (data.timestamp > lastSeenTimestamp) {
                addChatMessage(data.name, data.message);
                lastSeenTimestamp = data.timestamp;
              }
            }
          });

          ws.addEventListener("close", event => {
            console.log("WebSocket closed, reconnecting:", event.code, event.reason);
            rejoin();
          });
          ws.addEventListener("error", event => {
            console.log("WebSocket error, reconnecting:", event);
            rejoin();
          });
        }

        function addChatMessage(name, text) {
          let p = document.createElement("p");
          if (name) {
            let tag = document.createElement("span");
            tag.className = "username";
            tag.innerText = name + ": ";
            p.appendChild(tag);
          }
          p.appendChild(document.createTextNode(text));

          // Mark as system message
          if (!name || text.includes("Error") || text.includes("Welcome") || text.includes("WARNING")) {
            p.className = "system-message";
          }

          // Append the new chat line, making sure that if the chatlog was scrolled to the bottom
          // before, it remains scrolled to the bottom, and otherwise the scroll position doesn't
          // change.
          chatlog.appendChild(p);
          if (isAtBottom) {
            chatlog.scrollBy(0, 1e8);
          }
        }

        // ============================================
        // ENHANCED KEYBOARD HANDLING
        // (Added without changing original behavior)
        // ============================================
        
        function setupKeyboardHandling() {
          // Remove original form submit to prevent page refresh
          chatroom.addEventListener("submit", function(event) {
            event.preventDefault();
            // Actual send logic is now in keydown handler
          });
          
          // Enhanced keydown handler for better keyboard experience
          chatInput.addEventListener("keydown", function(event) {
            // Enter key without Shift = send message
            if (event.key === "Enter" && !event.shiftKey) {
              event.preventDefault();
              
              if (currentWebSocket && chatInput.value.trim()) {
                currentWebSocket.send(JSON.stringify({message: chatInput.value}));
                chatInput.value = "";
                
                // Auto-resize textarea
                chatInput.style.height = "auto";
                
                // Scroll to bottom
                chatlog.scrollBy(0, 1e8);
              }
            }
            // Shift+Enter = new line (allowed)
            // All other keys = normal behavior
          });
          
          // Auto-resize textarea as user types
          chatInput.addEventListener("input", function() {
            // Auto-resize
            this.style.height = "auto";
            this.style.height = Math.min(this.scrollHeight, 120) + "px";
            
            // Original validation (256 chars)
            if (this.value.length > 256) {
              this.value = this.value.slice(0, 256);
            }
          });
        }

        // Start the original app
        startNameChooser();
    </script>
  </body>
</html>
