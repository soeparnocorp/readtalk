<!DOCTYPE html>
<!--
  Edge Chat Demo - PWA smartphone friendly
  Mobile: Original edge-chat-demo flow preserved
  Desktop: WhatsApp Web positioning with red theme (#ff0000)
  DO behavior: 100% preserved, only CSS/positioning changed
-->

<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ff0000">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style type="text/css">
        /* ========== BASE STYLES ========== */
        * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
        }
        
        :root {
          --primary-color: #ff0000;
          --primary-dark: #cc0000;
          --primary-light: #ff3333;
          --bg-light: #ffffff;
          --bg-dark: #0c1317;
          --text-light: #333333;
          --text-dark: #e9edef;
          --border-light: #dddddd;
          --border-dark: #222d34;
          --bubble-incoming-light: #f0f0f0;
          --bubble-outgoing-light: #ff0000;
          --bubble-incoming-dark: #202c33;
          --bubble-outgoing-dark: #cc0000;
        }
        
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
          background: var(--bg-light);
          color: var(--text-light);
          height: 100vh;
          overflow: hidden;
          transition: background 0.3s, color 0.3s;
        }
        
        body.dark-mode {
          background: var(--bg-dark);
          color: var(--text-dark);
        }
        
        /* ========== MOBILE STYLES (Original edge-chat-demo flow) ========== */
        
        /* Forms - preserved original positioning */
        #name-form, #room-form {
          position: fixed;
          z-index: 100;
          top: 0;
          bottom: 0;
          left: 0;
          right: 0;
          background-color: var(--bg-light);
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          padding: 20px;
        }
        
        .dark-mode #name-form,
        .dark-mode #room-form {
          background-color: var(--bg-dark);
        }
        
        #name-input, #room-name {
          width: 90%;
          max-width: 400px;
          padding: 16px;
          font-size: 18px;
          border: 2px solid var(--border-light);
          border-radius: 8px;
          margin-bottom: 20px;
          text-align: center;
          background: var(--bg-light);
          color: var(--text-light);
        }
        
        .dark-mode #name-input,
        .dark-mode #room-name {
          background: var(--bubble-incoming-dark);
          border-color: var(--border-dark);
          color: var(--text-dark);
        }
        
        #room-form button, #go-public, #go-private {
          width: 90%;
          max-width: 400px;
          padding: 16px;
          font-size: 18px;
          border: none;
          border-radius: 8px;
          background: var(--primary-color);
          color: white;
          cursor: pointer;
          margin-bottom: 10px;
          transition: background 0.2s;
        }
        
        #go-public:hover, #go-private:hover {
          background: var(--primary-dark);
        }
        
        #go-private {
          background: #5856d6;
        }
        
        #room-form p {
          margin: 15px 0;
          color: var(--text-light);
          text-align: center;
        }
        
        .dark-mode #room-form p {
          color: var(--text-dark);
        }
        
        /* Chat container */
        #chatroom {
          position: fixed;
          top: 0;
          bottom: 0;
          left: 0;
          right: 0;
          display: flex;
          flex-direction: column;
          background: var(--bg-light);
        }
        
        .dark-mode #chatroom {
          background: var(--bg-dark);
        }
        
        /* Chat log - PWA optimized */
        #chatlog {
          flex: 1;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
          padding: 15px;
          padding-bottom: 70px;
          padding-top: 60px; /* Space for mobile header */
        }
        
        /* Mobile header (like WhatsApp) */
        .mobile-header {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          height: 60px;
          background: var(--primary-color);
          color: white;
          display: flex;
          align-items: center;
          padding: 0 15px;
          z-index: 10;
        }
        
        .back-button {
          background: none;
          border: none;
          color: white;
          font-size: 24px;
          cursor: pointer;
          padding: 8px;
          margin-right: 15px;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        
        .mobile-header-info {
          flex: 1;
        }
        
        .mobile-header-info h2 {
          font-size: 17px;
          font-weight: 500;
          margin-bottom: 2px;
        }
        
        .mobile-header-info p {
          font-size: 13px;
          opacity: 0.9;
        }
        
        /* Messages */
        #chatlog p {
          margin: 8px 0;
          padding: 12px 16px;
          border-radius: 18px;
          max-width: 85%;
          word-wrap: break-word;
          line-height: 1.4;
          position: relative;
        }
        
        /* Incoming messages */
        #chatlog p:not(.system-message) {
          background: var(--bubble-incoming-light);
          align-self: flex-start;
          margin-right: auto;
        }
        
        .dark-mode #chatlog p:not(.system-message) {
          background: var(--bubble-incoming-dark);
          color: var(--text-dark);
        }
        
        /* Outgoing messages */
        .message-outgoing {
          background: var(--bubble-outgoing-light) !important;
          color: white !important;
          align-self: flex-end !important;
          margin-left: auto !important;
          margin-right: 0 !important;
        }
        
        .dark-mode .message-outgoing {
          background: var(--bubble-outgoing-dark) !important;
        }
        
        /* Username styling */
        #chatlog span.username {
          font-weight: bold;
          display: block;
          margin-bottom: 4px;
        }
        
        .message-outgoing span.username {
          color: rgba(255, 255, 255, 0.9);
        }
        
        /* System messages */
        .system-message {
          align-self: center;
          background: rgba(255, 0, 0, 0.1);
          color: #cc0000;
          font-style: italic;
          text-align: center;
          font-size: 14px;
          max-width: 90%;
          margin: 12px auto !important;
          border: 1px solid rgba(255, 0, 0, 0.2);
        }
        
        .dark-mode .system-message {
          background: rgba(255, 0, 0, 0.15);
          color: #ff6666;
          border-color: rgba(255, 0, 0, 0.3);
        }
        
        /* Input area - PWA optimized */
        #chat-input-container {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background: var(--bg-light);
          border-top: 1px solid var(--border-light);
          padding: 10px;
          padding-bottom: max(10px, env(safe-area-inset-bottom));
          display: flex;
          align-items: center;
          gap: 10px;
          z-index: 10;
        }
        
        .dark-mode #chat-input-container {
          background: var(--bg-dark);
          border-top: 1px solid var(--border-dark);
        }
        
        #chat-input {
          flex: 1;
          padding: 12px 16px;
          border: 1px solid var(--border-light);
          border-radius: 20px;
          font-size: 16px;
          outline: none;
          min-height: 44px;
          max-height: 100px;
          resize: none;
          background: var(--bg-light);
          color: var(--text-light);
        }
        
        .dark-mode #chat-input {
          background: var(--bubble-incoming-dark);
          border: 1px solid var(--border-dark);
          color: var(--text-dark);
        }
        
        #send-button {
          width: 44px;
          height: 44px;
          border-radius: 50%;
          background: var(--primary-color);
          color: white;
          border: none;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: background 0.2s;
        }
        
        #send-button:hover {
          background: var(--primary-dark);
        }
        
        #send-button:disabled {
          background: #cccccc;
          cursor: not-allowed;
        }
        
        .dark-mode #send-button:disabled {
          background: #444444;
        }
        
        /* Roster - hidden on mobile */
        #roster {
          display: none;
        }
        
        /* Spacer */
        #spacer {
          height: 20px;
        }
        
        /* ========== DESKTOP STYLES (WhatsApp Web positioning) ========== */
        @media (min-width: 1025px) {
          body {
            background: var(--bg-dark);
            color: var(--text-dark);
          }
          
          /* WhatsApp Web layout */
          #chatroom {
            flex-direction: row;
            background: var(--bg-dark);
            max-width: 1600px;
            margin: 0 auto;
          }
          
          /* Sidebar (left) */
          #roster {
            display: flex;
            flex-direction: column;
            width: 480px;
            min-width: 380px;
            background: #111b21;
            border-right: 1px solid var(--border-dark);
            height: 100%;
          }
          
          /* Sidebar header with 3-dot menu */
          .sidebar-header {
            background: #202c33;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            border-bottom: 1px solid var(--border-dark);
          }
          
          .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
          }
          
          .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), #ff6666);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 18px;
          }
          
          /* Three-dot menu button */
          .menu-button {
            background: none;
            border: none;
            color: #aebac1;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
          }
          
          .menu-button:hover {
            background: rgba(255, 255, 255, 0.1);
          }
          
          /* Menu dropdown */
          .menu-dropdown {
            position: absolute;
            top: 60px;
            right: 10px;
            background: #202c33;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 100;
            display: none;
            min-width: 180px;
            border: 1px solid var(--border-dark);
          }
          
          .menu-dropdown.active {
            display: block;
          }
          
          .menu-item {
            padding: 12px 16px;
            color: #e9edef;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
          }
          
          .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
          }
          
          .menu-item i {
            width: 20px;
            text-align: center;
          }
          
          /* Room info */
          .room-info {
            padding: 20px;
            border-bottom: 1px solid var(--border-dark);
          }
          
          .room-info h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 18px;
          }
          
          /* Online users */
          .online-users {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
          }
          
          .online-users h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
          }
          
          .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #202c33;
            transition: background 0.2s;
          }
          
          .user-item:hover {
            background: #2a3942;
          }
          
          .user-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00a884;
            margin-left: auto;
          }
          
          /* Sidebar footer */
          .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--border-dark);
          }
          
          .sidebar-footer button {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
          }
          
          .sidebar-footer button:hover {
            background: var(--primary-dark);
          }
          
          /* Chat area (right) */
          #chatlog {
            flex: 1;
            background: var(--bg-dark);
            padding: 20px;
            right: 0;
            padding-top: 20px;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%2314222c' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E");
          }
          
          /* Desktop input */
          #chat-input-container {
            background: #202c33;
            border-top: 1px solid var(--border-dark);
            padding-bottom: 10px;
          }
          
          /* Hide mobile header on desktop */
          .mobile-header {
            display: none;
          }
          
          /* Desktop header */
          .desktop-header {
            background: #202c33;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
          }
          
          /* Message bubbles for desktop */
          #chatlog p:not(.system-message) {
            border-radius: 7.5px;
            border-top-left-radius: 0;
            max-width: 65%;
          }
          
          .message-outgoing {
            border-top-right-radius: 0 !important;
            border-top-left-radius: 7.5px !important;
          }
        }
        
        /* ========== TABLET STYLES ========== */
        @media (min-width: 769px) and (max-width: 1024px) {
          /* Simple roster on right */
          #roster {
            display: block;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 200px;
            background: #f8f8f8;
            border-left: 1px solid var(--border-light);
            padding: 15px;
            overflow-y: auto;
          }
          
          .dark-mode #roster {
            background: #111b21;
            border-left: 1px solid var(--border-dark);
          }
          
          #chatlog {
            right: 200px;
          }
          
          .mobile-header {
            display: none;
          }
        }
        
        /* ========== DARK MODE TOGGLE ========== */
        .dark-mode-toggle {
          position: fixed;
          bottom: 20px;
          right: 20px;
          width: 50px;
          height: 50px;
          border-radius: 50%;
          background: var(--primary-color);
          color: white;
          border: none;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 20px;
          z-index: 100;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
          transition: all 0.3s;
        }
        
        .dark-mode-toggle:hover {
          transform: scale(1.1);
          box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }
        
        /* ========== PWA INSTALL PROMPT ========== */
        .pwa-install-prompt {
          position: fixed;
          bottom: 80px;
          right: 20px;
          background: var(--primary-color);
          color: white;
          padding: 12px 16px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 99;
          display: none;
          max-width: 300px;
        }
        
        .pwa-install-prompt button {
          background: white;
          color: var(--primary-color);
          border: none;
          padding: 8px 16px;
          border-radius: 4px;
          margin-top: 8px;
          cursor: pointer;
          font-weight: 500;
        }
        
        /* ========== UTILITY CLASSES ========== */
        .hidden {
          display: none !important;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
          width: 6px;
        }
        
        ::-webkit-scrollbar-track {
          background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
          background: rgba(255, 0, 0, 0.3);
          border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
          background: rgba(255, 0, 0, 0.5);
        }
    </style>
  </head>
  <body>
    <!-- Name Form -->
    <div id="name-form">
      <input type="text" id="name-input" placeholder="your name" autocomplete="off" autofocus>
      <p style="text-align: center; margin-top: 20px; padding: 0 20px;">
        This chat runs entirely on the edge with Durable Objects
      </p>
    </div>

    <!-- Room Form -->
    <div id="room-form" class="hidden">
      <p>Public Room:</p>
      <input type="text" id="room-name" placeholder="room name" autocomplete="off">
      <button id="go-public">Go →</button>
      <p>OR</p>
      <button id="go-private">Private Room →</button>
    </div>

    <!-- Chat Room -->
    <div id="chatroom" class="hidden">
      <!-- Mobile Header -->
      <div class="mobile-header">
        <button class="back-button" id="back-button-mobile">
          <i class="fas fa-arrow-left"></i>
        </button>
        <div class="mobile-header-info">
          <h2 id="mobile-room-title">Chat Room</h2>
          <p id="mobile-room-status">Connecting...</p>
        </div>
      </div>

      <!-- Desktop Sidebar -->
      <div id="roster">
        <!-- Sidebar Header with 3-dot menu -->
        <div class="sidebar-header">
          <div class="user-info">
            <div class="user-avatar" id="desktop-user-avatar">U</div>
            <div>
              <div id="desktop-username" style="font-weight: 500;">User</div>
              <div style="font-size: 12px; color: #8696a0;">Online</div>
            </div>
          </div>
          <button class="menu-button" id="menu-button">
            <i class="fas fa-ellipsis-v"></i>
          </button>
          <!-- Menu Dropdown -->
          <div class="menu-dropdown" id="menu-dropdown">
            <div class="menu-item" id="toggle-dark-mode">
              <i class="fas fa-moon"></i>
              <span>Toggle Dark Mode</span>
            </div>
            <div class="menu-item" id="install-pwa">
              <i class="fas fa-download"></i>
              <span>Install App</span>
            </div>
            <div class="menu-item" id="clear-chat">
              <i class="fas fa-trash"></i>
              <span>Clear Chat</span>
            </div>
            <div class="menu-item" id="room-info">
              <i class="fas fa-info-circle"></i>
              <span>Room Info</span>
            </div>
          </div>
        </div>
        
        <!-- Room Info -->
        <div class="room-info">
          <h3>Room: <span id="desktop-room-name">General</span></h3>
          <div style="font-size: 14px; color: #8696a0; margin-top: 8px;">
            <i class="fas fa-users"></i>
            <span id="online-count">1</span> users online
          </div>
        </div>
        
        <!-- Online Users -->
        <div class="online-users">
          <h3><i class="fas fa-user-friends"></i> Online Users</h3>
          <div id="user-list"></div>
        </div>
        
        <!-- Sidebar Footer -->
        <div class="sidebar-footer">
          <button id="leave-button">
            <i class="fas fa-sign-out-alt"></i> Leave Room
          </button>
        </div>
      </div>

      <!-- Chat Messages -->
      <div id="chatlog">
        <div id="spacer"></div>
      </div>

      <!-- Input Area -->
      <div id="chat-input-container">
        <textarea id="chat-input" placeholder="Type your message..." disabled></textarea>
        <button id="send-button" disabled>
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>

    <!-- Dark Mode Toggle (floating button) -->
    <button class="dark-mode-toggle" id="dark-mode-toggle">
      <i class="fas fa-moon"></i>
    </button>

    <!-- PWA Install Prompt -->
    <div class="pwa-install-prompt" id="pwa-install-prompt">
      <p>Install Chat App for better experience?</p>
      <button id="pwa-install-button">Install</button>
      <button id="pwa-dismiss-button" style="background: transparent; color: white; margin-left: 8px;">Later</button>
    </div>

    <script>
        // ============================================
        // ORIGINAL EDGE-CHAT-DEMO JAVASCRIPT
        // PRESERVED 100% - NO BEHAVIOR CHANGES
        // ============================================
        
        let currentWebSocket = null;
        let nameForm = document.querySelector("#name-form");
        let nameInput = document.querySelector("#name-input");
        let roomForm = document.querySelector("#room-form");
        let roomNameInput = document.querySelector("#room-name");
        let goPublicButton = document.querySelector("#go-public");
        let goPrivateButton = document.querySelector("#go-private");
        let chatroom = document.querySelector("#chatroom");
        let chatlog = document.querySelector("#chatlog");
        let chatInput = document.querySelector("#chat-input");
        let sendButton = document.querySelector("#send-button");
        let roster = document.querySelector("#roster");
        let userList = document.querySelector("#user-list");

        let isAtBottom = true;
        let username;
        let roomname;
        let hostname = window.location.host;
        if (hostname == "") {
          hostname = "localhost:8787";
        }

        // ============================================
        // NEW UI ELEMENTS (added without changing DO behavior)
        // ============================================
        
        // Mobile elements
        let backButtonMobile = document.querySelector("#back-button-mobile");
        let mobileRoomTitle = document.querySelector("#mobile-room-title");
        let mobileRoomStatus = document.querySelector("#mobile-room-status");
        let leaveButton = document.querySelector("#leave-button");
        
        // Desktop elements
        let desktopUserAvatar = document.querySelector("#desktop-user-avatar");
        let desktopUsername = document.querySelector("#desktop-username");
        let desktopRoomName = document.querySelector("#desktop-room-name");
        let onlineCount = document.querySelector("#online-count");
        
        // Menu elements
        let menuButton = document.querySelector("#menu-button");
        let menuDropdown = document.querySelector("#menu-dropdown");
        let toggleDarkModeBtn = document.querySelector("#toggle-dark-mode");
        let installPwaBtn = document.querySelector("#install-pwa");
        let clearChatBtn = document.querySelector("#clear-chat");
        let roomInfoBtn = document.querySelector("#room-info");
        
        // Theme elements
        let darkModeToggle = document.querySelector("#dark-mode-toggle");
        let darkModeIcon = darkModeToggle.querySelector("i");
        
        // PWA elements
        let pwaInstallPrompt = document.querySelector("#pwa-install-prompt");
        let pwaInstallButton = document.querySelector("#pwa-install-button");
        let pwaDismissButton = document.querySelector("#pwa-dismiss-button");
        
        // ============================================
        // ORIGINAL FUNCTIONS (unchanged)
        // ============================================
        
        function startNameChooser() {
          nameForm.addEventListener("submit", event => {
            event.preventDefault();
            username = nameInput.value;
            if (username.length > 0) {
              startRoomChooser();
            }
          });

          nameInput.addEventListener("input", event => {
            if (event.currentTarget.value.length > 32) {
              event.currentTarget.value = event.currentTarget.value.slice(0, 32);
            }
          });

          nameInput.focus();
        }

        function startRoomChooser() {
          nameForm.classList.add("hidden");

          if (document.location.hash.length > 1) {
            roomname = document.location.hash.slice(1);
            startChat();
            return;
          }

          roomForm.classList.remove("hidden");

          roomForm.addEventListener("submit", event => {
            event.preventDefault();
            roomname = roomNameInput.value;
            if (roomname.length > 0) {
              startChat();
            }
          });

          roomNameInput.addEventListener("input", event => {
            if (event.currentTarget.value.length > 32) {
              event.currentTarget.value = event.currentTarget.value.slice(0, 32);
            }
          });

          goPublicButton.addEventListener("click", event => {
            roomname = roomNameInput.value;
            if (roomname.length > 0) {
              startChat();
            }
          });

          goPrivateButton.addEventListener("click", async event => {
            roomNameInput.disabled = true;
            goPublicButton.disabled = true;
            event.currentTarget.disabled = true;

            let response = await fetch("https://" + hostname + "/api/room", {method: "POST"});
            if (!response.ok) {
              alert("something went wrong");
              document.location.reload();
              return;
            }

            roomname = await response.text();
            startChat();
          });

          roomNameInput.focus();
        }

        function startChat() {
          roomForm.classList.add("hidden");

          // Normalize the room name a bit.
          roomname = roomname.replace(/[^a-zA-Z0-9_-]/g, "").replace(/_/g, "-").toLowerCase();

          if (roomname.length > 32 && !roomname.match(/^[0-9a-f]{64}$/)) {
            addChatMessage("ERROR", "Invalid room name.");
            return;
          }

          document.location.hash = "#" + roomname;

          // Update UI elements
          mobileRoomTitle.textContent = roomname;
          desktopRoomName.textContent = roomname;
          desktopUserAvatar.textContent = username.charAt(0).toUpperCase();
          desktopUsername.textContent = username;

          // Setup event listeners (original)
          chatInput.addEventListener("input", event => {
            if (event.currentTarget.value.length > 256) {
              event.currentTarget.value = event.currentTarget.value.slice(0, 256);
            }
            sendButton.disabled = chatInput.value.trim().length === 0;
          });

          chatroom.addEventListener("submit", event => {
            event.preventDefault();
            if (currentWebSocket) {
              currentWebSocket.send(JSON.stringify({message: chatInput.value}));
              chatInput.value = "";
              sendButton.disabled = true;
              chatlog.scrollBy(0, 1e8);
            }
          });

          chatlog.addEventListener("scroll", event => {
            isAtBottom = chatlog.scrollTop + chatlog.clientHeight >= chatlog.scrollHeight;
          });

          // New UI event listeners (added without affecting DO behavior)
          setupNewUIEvents();

          chatInput.disabled = false;
          chatroom.classList.remove("hidden");
          chatInput.focus();

          // Mobile keyboard resize handling
          if('visualViewport' in window) {
            window.visualViewport.addEventListener('resize', function(event) {
              if (isAtBottom) {
                chatlog.scrollBy(0, 1e8);
              }
            });
          }

          join();
        }

        function leaveRoom() {
          if (currentWebSocket) {
            currentWebSocket.close();
            currentWebSocket = null;
          }
          
          chatroom.classList.add("hidden");
          nameForm.classList.remove("hidden");
          roomForm.classList.add("hidden");
          nameInput.value = "";
          roomNameInput.value = "";
          chatInput.value = "";
          chatlog.innerHTML = '<div id="spacer"></div>';
          userList.innerHTML = "";
          
          document.location.hash = "";
          nameInput.focus();
        }

        let lastSeenTimestamp = 0;
        let wroteWelcomeMessages = false;

        function join() {
          const wss = document.location.protocol === "http:" ? "ws://" : "wss://";
          let ws = new WebSocket(wss + hostname + "/api/room/" + roomname + "/websocket");
          let rejoined = false;
          let startTime = Date.now();

          let rejoin = async () => {
            if (!rejoined) {
              rejoined = true;
              currentWebSocket = null;

              while (userList.firstChild) {
                userList.removeChild(userList.firstChild);
              }

              let timeSinceLastJoin = Date.now() - startTime;
              if (timeSinceLastJoin < 10000) {
                await new Promise(resolve => setTimeout(resolve, 10000 - timeSinceLastJoin));
              }

              join();
            }
          }

          ws.addEventListener("open", event => {
            currentWebSocket = ws;
            mobileRoomStatus.textContent = "Connected";
            ws.send(JSON.stringify({name: username}));
          });

          ws.addEventListener("message", event => {
            let data = JSON.parse(event.data);

            if (data.error) {
              addChatMessage(null, "* Error: " + data.error);
            } else if (data.joined) {
              let p = document.createElement("p");
              p.innerText = data.joined;
              userList.appendChild(p);
              updateOnlineCount();
            } else if (data.quit) {
              for (let child of userList.childNodes) {
                if (child.innerText == data.quit) {
                  userList.removeChild(child);
                  break;
                }
              }
              updateOnlineCount();
            } else if (data.ready) {
              if (!wroteWelcomeMessages) {
                wroteWelcomeMessages = true;
                addChatMessage(null,
                    "* This is a demo app built with Durable Objects.");
                addChatMessage(null,
                    "* WARNING: Participants in this chat are random people on the internet. " +
                    "Names are not authenticated. Chat history is saved.");
                if (roomname.length == 64) {
                  addChatMessage(null,
                      "* This is a private room. You can invite someone by sending them the URL.");
                } else {
                  addChatMessage(null,
                      "* Welcome to #" + roomname + ". Say hi!");
                }
              }
            } else {
              if (data.timestamp > lastSeenTimestamp) {
                addChatMessage(data.name, data.message);
                lastSeenTimestamp = data.timestamp;
              }
            }
          });

          ws.addEventListener("close", event => {
            console.log("WebSocket closed, reconnecting:", event.code, event.reason);
            mobileRoomStatus.textContent = "Reconnecting...";
            rejoin();
          });
          
          ws.addEventListener("error", event => {
            console.log("WebSocket error, reconnecting:", event);
            rejoin();
          });
        }

        function addChatMessage(name, text) {
          let p = document.createElement("p");
          if (name) {
            let tag = document.createElement("span");
            tag.className = "username";
            tag.innerText = name + ": ";
            p.appendChild(tag);
            
            // Mark outgoing messages
            if (name === username) {
              p.classList.add("message-outgoing");
            }
          }
          p.appendChild(document.createTextNode(text));

          if (text.includes("joined") || text.includes("left") || text.includes("Welcome") || text.includes("WARNING") || text.includes("Error")) {
            p.className = "system-message";
          }

          chatlog.appendChild(p);
          if (isAtBottom) {
            chatlog.scrollBy(0, 1e8);
          }
        }
        
        function updateOnlineCount() {
          let count = userList.childNodes.length + 1;
          onlineCount.textContent = count;
        }

        // ============================================
        // NEW UI FUNCTIONALITY (added on top of original)
        // ============================================
        
        function setupNewUIEvents() {
          // Mobile back button
          backButtonMobile.addEventListener("click", leaveRoom);
          
          // Desktop leave button
          leaveButton.addEventListener("click", leaveRoom);
          
          // Menu button
          menuButton.addEventListener("click", (e) => {
            e.stopPropagation();
            menuDropdown.classList.toggle("active");
          });
          
          // Close menu when clicking outside
          document.addEventListener("click", () => {
            menuDropdown.classList.remove("active");
          });
          
          // Dark mode toggle
          toggleDarkModeBtn.addEventListener("click", toggleDarkMode);
          darkModeToggle.addEventListener("click", toggleDarkMode);
          
          // Clear chat (local only)
          clearChatBtn.addEventListener("click", () => {
            if (confirm("Clear chat history? (This only clears your view)")) {
              const messages = chatlog.querySelectorAll("p:not(.system-message)");
              messages.forEach(msg => {
                if (!msg.textContent.includes("Welcome") && 
                    !msg.textContent.includes("WARNING") && 
                    !msg.textContent.includes("Error")) {
                  msg.remove();
                }
              });
            }
          });
          
          // Room info
          roomInfoBtn.addEventListener("click", () => {
            alert(`Room: ${roomname}\nUsers online: ${userList.childNodes.length + 1}\nYour name: ${username}`);
          });
          
          // PWA install
          installPwaBtn.addEventListener("click", showPwaInstallPrompt);
          pwaInstallButton.addEventListener("click", installPwa);
          pwaDismissButton.addEventListener("click", () => {
            pwaInstallPrompt.style.display = "none";
          });
        }
        
        function toggleDarkMode() {
          document.body.classList.toggle("dark-mode");
          if (document.body.classList.contains("dark-mode")) {
            darkModeIcon.className = "fas fa-sun";
            localStorage.setItem("darkMode", "enabled");
          } else {
            darkModeIcon.className = "fas fa-moon";
            localStorage.setItem("darkMode", "disabled");
          }
        }
        
        function showPwaInstallPrompt() {
          pwaInstallPrompt.style.display = "block";
          menuDropdown.classList.remove("active");
        }
        
        function installPwa() {
          // PWA install logic would go here
          alert("PWA installation triggered. In a real app, this would install the app.");
          pwaInstallPrompt.style.display = "none";
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        // Load dark mode preference
        if (localStorage.getItem("darkMode") === "enabled") {
          document.body.classList.add("dark-mode");
          darkModeIcon.className = "fas fa-sun";
        }
        
        // Start the original app
        startNameChooser();
        
        // PWA detection
        window.addEventListener('beforeinstallprompt', (e) => {
          // Store the event for later use
          window.deferredPrompt = e;
          // Show install button in menu
          installPwaBtn.style.display = "flex";
        });
        
        // Service Worker registration for PWA
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('sw.js').then(() => {
            console.log('Service Worker registered');
          }).catch(err => {
            console.log('Service Worker registration failed:', err);
          });
        }
    </script>
  </body>
</html>
